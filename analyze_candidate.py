import openai
import os

openai.api_key = os.getenv("OPENAI_API_KEY")

def format_qa(questions: list, answers: list) -> str:
    lines = []
    for i in range(len(questions)):
        q = questions[i]
        a = answers[i] if i < len(answers) else "-"
        lines.append(f"–í–æ–ø—Ä–æ—Å: {q}\n–û—Ç–≤–µ—Ç: {a}\n")
    return "\n".join(lines)

def analyze_candidate(user_data: dict) -> str:
    full_name = user_data.get("full_name", "–ö–∞–Ω–¥–∏–¥–∞—Ç")
    age = user_data.get("age", "‚Äî")
    gender = user_data.get("gender", "‚Äî")

    # –ë–ª–æ–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    personality_result = user_data.get("personality_result", "")
    maslow_result = user_data.get("maslow_result", "")
    iq_result = user_data.get("iq_result", "")

    # –í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã
    personality_qas = format_qa(
        user_data.get("personality_test_questions", []),
        user_data.get("personality_answers", [])
    )

    maslow_qas = format_qa(
        user_data.get("maslow_test_questions", []),
        user_data.get("maslow_answers", [])
    )

    iq_qas = format_qa(
        user_data.get("iq_test_questions", []),
        user_data.get("iq_scores", [])
    )

    prompt = f"""
–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π HR-–∞–Ω–∞–ª–∏—Ç–∏–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º 3 —Ç–µ—Å—Ç–æ–≤:

1. –¢–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏ (soft-skills)
2. –ú–æ—Ç–∏–≤–∞—Ü–∏—è (–ø–æ –ø–∏—Ä–∞–º–∏–¥–µ –ú–∞—Å–ª–æ—É)
3. –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç (IQ)

üîπ –£—á–∏—Ç—ã–≤–∞–π –∫–∞–∫ –∏—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, —Ç–∞–∫ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–∞. –í–∞–∂–Ω–æ –ø–æ–Ω—è—Ç—å, –Ω–∞—Å–∫–æ–ª—å–∫–æ –∫–∞–Ω–¥–∏–¥–∞—Ç:
‚Äî –≥–æ—Ç–æ–≤ –∫ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ;
‚Äî —É—Å—Ç–æ–π—á–∏–≤ –∫ —Å—Ç—Ä–µ—Å—Å—É;
‚Äî —Å–ø–æ—Å–æ–±–µ–Ω –∫ –æ–±—É—á–µ–Ω–∏—é;
‚Äî –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –∫–æ–º–∞–Ω–¥–Ω—É—é/–ª–∏–¥–µ—Ä—Å–∫—É—é —Ä–æ–ª—å;
‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–æ–±–ª–µ–º–µ–Ω.

üìå –î–∞–Ω–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:
–§–ò–û: {full_name}
–í–æ–∑—Ä–∞—Å—Ç: {age}
–ü–æ–ª: {gender}

üìç –û–±—Ä–∞—Ç–∏ –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –≤–æ–∑—Ä–∞—Å—Ç –∏ –ø–æ–ª –∫–∞–Ω–¥–∏–¥–∞—Ç–∞. –ù–∞–ø—Ä–∏–º–µ—Ä:
‚Äî 19-–ª–µ—Ç–Ω–∏–π –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–ª–∞–±—É—é —Å–∞–º–æ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é, –∏ —ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ.
‚Äî 35-–ª–µ—Ç–Ω–∏–π —Å –Ω–∏–∑–∫–∏–º —É—Ä–æ–≤–Ω–µ–º IQ ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫.
‚Äî –ú—É–∂—á–∏–Ω–∞ –∏ –∂–µ–Ω—â–∏–Ω–∞ –º–æ–≥—É—Ç –ø–æ-—Ä–∞–∑–Ω–æ–º—É –≤—ã—Ä–∞–∂–∞—Ç—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –∏–ª–∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω–æ—Å—Ç—å.

üìé –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ –Ω–∞ —Ç–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏:
{personality_result}

üìé –í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã:
{personality_qas}

üìé –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ –ø–æ –ú–∞—Å–ª–æ—É:
{maslow_result}

üìé –í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã:
{maslow_qas}

üìé –†–µ–∑—É–ª—å—Ç–∞—Ç—ã IQ —Ç–µ—Å—Ç–∞:
{iq_result}

üìé –í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã:
{iq_qas}

–°—Ñ–æ—Ä–º–∏—Ä—É–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç—á—ë—Ç –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:

==============================

üßæ –ü—Ä–æ—Ñ–∏–ª—å –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:
–§–ò–û, –≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª

‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:
- ...

‚ö†Ô∏è –°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:
- ...

üö® –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã:
- (...–µ—Å–ª–∏ –µ—Å—Ç—å)

üß™ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è HR:
- (...–∫–∞–∫ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ø—Ä–æ—Ñ–ø—Ä–∏–≥–æ–¥–Ω–æ—Å—Ç—å)

üìä –û—Ü–µ–Ω–∫–∞ –ø–æ 10-–±–∞–ª–ª—å–Ω–æ–π —à–∫–∞–ª–µ:
- X/10 (10 ‚Äî –∏–¥–µ–∞–ª–µ–Ω, 5 ‚Äî —Å—Ä–µ–¥–Ω–µ, <5 ‚Äî —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω–æ)

üí¨ –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:
- (...)

==============================

üñä –¢–æ–Ω –æ—Ç—á—ë—Ç–∞ ‚Äî —á—ë—Ç–∫–∏–π, –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ –≤–æ–¥—ã.
"""

    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[
            {
                "role": "system",
                "content": (
                    "–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π HR-–∞–Ω–∞–ª–∏—Ç–∏–∫. "
                    "–û—Ü–µ–Ω–∏–≤–∞–π –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º —Ç–µ—Å—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤. "
                    "‚ö†Ô∏è –í–ê–ñ–ù–û: —É—á–∏—Ç—ã–≤–∞–π –≤–æ–∑—Ä–∞—Å—Ç –∏ –ø–æ–ª –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –∫–∞–∫ –∫–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏. "
                    "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Ç–µ—Å—Ç–∞ –º–æ–≥—É—Ç –æ–∑–Ω–∞—á–∞—Ç—å —Ä–∞–∑–Ω–æ–µ –¥–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —Ä–∞–∑–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏–ª–∏ –ø–æ–ª–∞. "
                    "–û—Ü–µ–Ω–∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –∑—Ä–µ–ª–æ—Å—Ç—å, —É—Ä–æ–≤–µ–Ω—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∏ –º–æ—Ç–∏–≤–∞—Ü–∏—é —Å —É—á—ë—Ç–æ–º —ç—Ç–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤."
                )
            },
            {"role": "user", "content": prompt}
        ],
        temperature=0.6,
        max_tokens=1000
    )

    base_summary = response.choices[0].message.content.strip()

    # –î–æ–±–∞–≤–∏–º –±–ª–æ–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ª–∏—á–Ω–æ—Å—Ç–∏ –∏ –ú–∞—Å–ª–æ—É –≤ –∫–æ–Ω–µ—Ü –æ—Ç—á–µ—Ç–∞
    detailed_summary = f"{base_summary}\n\nüìå –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —à–∫–∞–ª–∞–º:\n\nüß† –¢–∏–ø –ª–∏—á–Ω–æ—Å—Ç–∏:\n{personality_result}\n\nüéØ –ú–∞—Å–ª–æ—É:\n{maslow_result}"

    return detailed_summary
